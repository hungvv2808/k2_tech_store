<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/admin/template/template.xhtml">

    <f:metadata>
        <f:event type="preRenderView" listener="#{paymentController.initData}"/>
    </f:metadata>

    <ui:define name="title">Quản lý giao dịch</ui:define>

    <ui:define name="breadcrumb">
        <li>
            <p:link outcome="/admin/quan-ly-chung/quan-ly-giao-dich">Quản lý danh mục / Quản lý giao dịch</p:link>
        </li>
    </ui:define>
    <ui:define name="content">

        <style>
            .ui-selectonemenu-panel .ui-selectonemenu-items-wrapper {
                max-width: 561px !important;
            }
        </style>

        <div class="ui-fluid">
            <div class="ui-fluid">
                <h:form id="dialogRegulation">
                    <p:dialog header="Quy chế đấu giá" showEffect="clip" hideEffect="clip"
                              styleClass="text-center"
                              style="max-height: 90vh; max-width: 90vw"
                              widgetVar="detailInfoDialogRegulation" modal="true" height="600" width="800">
                        <p:scrollPanel mode="native"
                                       style="width: 100%; height: 100%; border: none; overflow-y: hidden;">
                            <p:media value="/resources#{paymentController.regulationFilePath}" player="pdf" width="100%" height="100%">
                                Không thể hiển thị được file tải lên, <h:outputLink value="#{request.contextPath}/resources#{paymentController.regulationFilePath}">bấm vào đây</h:outputLink> để tải file về
                            </p:media>
                        </p:scrollPanel>
                    </p:dialog>
                </h:form>
            </div>

            <p:dialog id="dlg" header="Thông tin giao dịch"
                      style="max-height: 90vh; max-width: 90vw"
                      rendered="#{paymentController.getActions().hasAction(EAction.CREATE,EAction.UPDATE)}"
                      widgetVar="dialogInsertUpdate" modal="true" width="800">
                <h:form id="dlForm" enctype="multipart/form-data">
                    <p:scrollPanel mode="native" style="width: 100%; max-height: 90vh; border: none">
                        <p:panelGrid id="basicPanel1" columns="2"
                                     columnClasses="ui-grid-col-3,ui-grid-col-9"
                                     styleClass="ui-panelgrid-blank" layout="grid">

                            <p:outputLabel value="Tài sản thanh toán:" for="asset"/>
                            <p:outputPanel>
                                <p:selectOneMenu id="asset" autoWidth="false" effect="fade" required="true"
                                                 requiredMessage="Bạn vui lòng chọn tài sản thanh toán"
                                                 value="#{paymentController.assetId}" filter="true"
                                                 disabled="#{paymentController.disable}"
                                                 filterMatchMode="contains">
                                    <f:selectItem itemLabel="Chọn tài sản thanh toán" itemValue=""/>
                                    <f:selectItems value="#{paymentController.assetList}"/>
                                    <p:ajax event="change"
                                            global="false"
                                            listener="#{paymentController.onChangeAsset(paymentController.assetId)}"
                                            update="money code time"/>
                                </p:selectOneMenu>
                                <p:message id="id2" for="asset" styleClass="focus-input-text" display="text"/>
                            </p:outputPanel>

                            <p:outputLabel value="Người giao dịch:" for="code"/>
                            <p:outputPanel>
                                <p:selectOneMenu id="code" autoWidth="false" effect="fade" required="true"
                                                 requiredMessage="Bạn vui lòng chọn người giao dịch"
                                                 value="#{paymentController.accountId}" filter="true"
                                                 disabled="#{paymentController.disable}"
                                                 filterMatchMode="contains">
                                    <f:selectItem itemLabel="Chọn người giao dịch" itemValue=""/>
                                    <f:selectItems value="#{paymentController.accountList}"/>
                                </p:selectOneMenu>
                                <p:message id="id1" for="code" styleClass="focus-input-text" display="text"/>
                            </p:outputPanel>

                            <p:outputLabel styleClass="requireLabel" value="Số tiền giao dịch: " for="money"/>
                            <p:inputNumber id="money" placeholder="Số tiền giao dịch" disabled="#{paymentController.disable}"
                                           value="#{paymentController.payment.money}"/>

                            <p:outputLabel value="Hình thức thanh toán:" for="formality"/>
                            <p:outputPanel>
                                <p:selectOneMenu id="formality" autoWidth="false" effect="fade" required="true"
                                                 requiredMessage="Bạn vui lòng chọn hình thức thanh toán"
                                                 value="#{paymentController.payment.paymentFormality}"
                                                 disabled="#{paymentController.disable}"
                                                 filterMatchMode="contains">
                                    <f:selectItem itemLabel="Chọn hình thức thanh toán" itemValue=""/>
                                    <f:selectItem itemLabel="Thanh toán trực tiếp trên hệ thống" itemValue="1"/>
                                    <f:selectItem itemLabel="Thanh toán ngoài hệ thống" itemValue="2"/>
                                </p:selectOneMenu>
                                <p:message id="id3" for="formality" styleClass="focus-input-text" display="text"/>
                            </p:outputPanel>

                            <p:outputLabel styleClass="requireLabel" value="Thời gian giao dịch:"/>
                            <p:outputPanel>
                                <p:datePicker styleClass="calendar" id="time" locale="vi_VN"
                                              monthNavigator="true" yearNavigator="true" yearRange="#{commonController.yearNow}:2100"
                                              label="Chọn thời gian giao dịch"
                                              placeholder="Chọn thời gian giao dịch"
                                              converterMessage="Thời gian giao dịch không đúng định dạng dd/MM/yyyy"
                                              validatorMessage="Vui lòng nhập thời gian giao dịch nhỏ hơn hoặc bằng thời gian hiện tại"
                                              requiredMessage="Bạn vui lòng nhập thời gian giao dịch"
                                              disabled="#{paymentController.disable}"
                                              required="true"
                                              autocomplete="off"
                                              maxdate="#{paymentController.timeNow}"
                                              value="#{paymentController.payment.createDate}">
                                    <f:convertDateTime pattern="HH:mm, dd/MM/yyyy"/>
                                </p:datePicker>
                                <p:message id="id4" for="time" styleClass="focus-input-text" display="text"/>
                            </p:outputPanel>

                            <p:outputLabel value="Trạng thái giao dịch:" for="status"/>
                            <p:outputPanel>
                                <p:selectOneMenu id="status" autoWidth="false" effect="fade" required="true"
                                                 requiredMessage="Bạn vui lòng chọn trạng thái giao dịch"
                                                 value="#{paymentController.payment.status}"
                                                 disabled="#{paymentController.disable}"
                                                 filterMatchMode="contains">
                                    <f:selectItem itemLabel="Chọn trạng thái giao dịch" itemValue=""/>
                                    <f:selectItem itemLabel="Đã nhận được tiền" itemValue="1"/>
                                    <f:selectItem itemLabel="Đã trả lại tiền đặt trước" itemValue="2"/>
                                </p:selectOneMenu>
                                <p:message id="id5" for="status" styleClass="focus-input-text" display="text"/>
                            </p:outputPanel>

                            <p:outputLabel value="Ghi chú giao dịch:" for="note"/>
                            <p:inputTextarea id="note" placeholder="Nhập ghi chú cho giao dịch"
                                             value="#{paymentController.payment.note}"/>

                            <p:outputLabel value="File đính kèm:"/>
                            <p:panelGrid columns="1" columnClasses="ui-grid-col-12 ui-no-margin-padding"
                                         styleClass="ui-panelgrid-blank" layout="grid">
                                <ui:include src="/common/upload-single-file-disable-download.xhtml"/>
                                <p:outputLabel>(Vui lòng chọn tài liệu định dạng PDF, DOCX, JPG, JPEG, PNG dung lượng nhỏ hơn 5MB)</p:outputLabel>
                            </p:panelGrid>

                        </p:panelGrid>

                        <p:panelGrid columns="3"
                                     columnClasses="ui-grid-col-1.5,ui-grid-col-1.5"
                                     layout="grid" styleClass="ui-panelgrid-blank">
                            <p:commandButton value="Lưu" actionListener="#{paymentController.onSaveData}"
                                             icon="fa fa-save" style="width: 80px" update="id1 id2 id3 id4 id5 "/>
                            <p:commandButton value="Ðóng" styleClass="close"
                                             actionListener="#{paymentController.resetDialog}"
                                             oncomplete="PF('dialogInsertUpdate').hide()" icon="fa fa-close"
                                             style="width: 80px"/>
                        </p:panelGrid>

                    </p:scrollPanel>
                </h:form>
            </p:dialog>
        </div>

        <h:form id="searchForm">
            <div class="ui-fluid">
                <div class="ui-g">
                    <div class="ui-g-12" style="padding-top:0">
                        <div class="card no-margin">
                            <p:panel header="Tìm kiếm giao dịch"
                                     rendered="#{paymentController.getActions().canSearch()}" style="margin-bottom:5px">
                                <p:panelGrid id="searchPanel" columns="4" styleClass="ui-panelgrid-blank" layout="grid"
                                             columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4">
                                    <p:outputLabel value="Tài sản thanh toán:"/>
                                    <p:selectOneMenu id="sasset" autoWidth="false" effect="fade" filter="true"
                                                     value="#{paymentController.paymentSearchDto.assetId}"
                                                     filterMatchMode="contains">
                                        <f:selectItem itemLabel="Tất cả" itemValue=""/>
                                        <f:selectItems value="#{paymentController.assetList}"/>
                                        <p:ajax event="change"
                                                global="false"
                                                listener="#{paymentController.onChangeAssetToSearch(paymentController.paymentSearchDto.assetId)}"
                                                update="user"/>
                                    </p:selectOneMenu>

                                    <p:outputLabel value="Người giao dịch:"/>
                                    <p:selectOneMenu id="user" value="#{paymentController.paymentSearchDto.accountId}"
                                                     filterMatchMode="contains" filter="true">
                                        <f:selectItem itemLabel="Tất cả" itemValue=""/>
                                        <f:selectItems value="#{paymentController.accountList}"/>
                                    </p:selectOneMenu>

                                    <p:outputLabel value="Hình thức giao dịch:"/>
                                    <p:selectOneMenu value="#{paymentController.paymentSearchDto.paymentFormality}"
                                                     filterMatchMode="contains">
                                        <f:selectItem itemLabel="Tất cả" itemValue=""/>
                                        <f:selectItem itemLabel="Thanh toán trực tiếp trên hệ thống" itemValue="1"/>
                                        <f:selectItem itemLabel="Thanh toán ngoài hệ thống" itemValue="2"/>
                                    </p:selectOneMenu>

                                    <p:outputLabel value="Thời gian giao dịch:"/>
                                    <p:panelGrid columns="3" styleClass="ui-panelgrid-blank" layout="grid"
                                                 columnClasses="ui-grid-col-5 ui-no-margin-padding, ui-grid-col-2 ui-no-margin-padding, ui-grid-col-5 ui-no-margin-padding">
                                        <p:calendar styleClass="calendar" id="startTime"
                                                    mask="true" navigator="true" mode="popup" placeholder="Từ ngày"
                                                    label="Thời gian"
                                                    readonlyInput="true"
                                                    value="#{paymentController.paymentSearchDto.fromDate}"
                                                    maxdate="#{paymentController.paymentSearchDto.toDate}">
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                            <p:ajax event="dateSelect"
                                                    listener="#{paymentController.onDateSelect}"
                                                    update="endTime"/>
                                        </p:calendar>
                                        <p:outputLabel value=""/>
                                        <p:calendar styleClass="calendar" mask="true"
                                                    navigator="true" mode="popup" placeholder="Đến ngày"
                                                    id="endTime" label="Thời gian"
                                                    readonlyInput="true"
                                                    value="#{paymentController.paymentSearchDto.toDate}"
                                                    mindate="#{paymentController.paymentSearchDto.fromDate}">
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                            <p:ajax event="dateSelect"
                                                    listener="#{paymentController.onDateSelect}"
                                                    update="startTime"/>
                                        </p:calendar>
                                    </p:panelGrid>

                                    <p:outputLabel value="Trạng thái:"/>
                                    <p:selectOneMenu value="#{paymentController.paymentSearchDto.status}"
                                                     filterMatchMode="contains">
                                        <f:selectItem itemLabel="Tất cả" itemValue=""/>
                                        <f:selectItem itemLabel="Đã nhận được tiền" itemValue="1"/>
                                        <f:selectItem itemLabel="Đã trả lại tiền trước" itemValue="2"/>
                                    </p:selectOneMenu>
                                </p:panelGrid>

                                <p:panelGrid columns="3" styleClass="ui-panelgrid-blank" layout="grid"
                                             columnClasses="ui-grid-col-1.5,ui-grid-col-1.5,ui-grid-col-1.5">
                                    <p:commandButton value="Tìm kiếm"
                                                     actionListener="#{paymentController.onSearch()}"
                                                     update="searchForm tblSearchResult" icon="fa fa-search"
                                                     style="width: 100px"/>
                                    <p:commandButton value="Làm mới"
                                                     actionListener="#{paymentController.refresh()}"
                                                     update="searchForm tblSearchResult" icon="fa fa-refresh"
                                                     styleClass="orange-btn" style="width: 100px"/>
                                    <h:commandLink rendered="#{paymentController.lazyDataModel.rowCount > 0}">
                                        <p:commandButton value="Xuất dữ liệu" icon="fa fa-copy" type="button"/>
                                        <p:dataExporter type="xlsx" target="tblSearchResult"
                                                        fileName="GiaoDich"/>
                                    </h:commandLink>
                                </p:panelGrid>
                            </p:panel>

                            <p:panel id="searchResult" header="Kết quả tìm kiếm" style="margin-bottom:5px">
                                <p:dataTable id="tblSearchResult" tableStyle="table-layout: auto;"
                                             widgetVar="wdgNhomQuyen" resizableColumns="true" paginator="true"
                                             rows="10"
                                             value="#{paymentController.lazyDataModel}"
                                             lazy="true" pageLinks="5" paginatorPosition="top" var="resultDto"
                                             paginatorAlwaysVisible="true" rowsPerPageTemplate="10,20,50,100"
                                             paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                             currentPageReportTemplate="#{t['lbl.recordTotal']}: #{paymentController.lazyDataModel.rowCount}"
                                             emptyMessage="#{t['lbl.emptyTable']}" rowIndexVar="rowIndex"
                                             rowKey="#{resultDto.paymentId}">
                                    <p:column headerText="Chi tiết" width="20" exportable="false">
                                        <p:rowToggler/>
                                    </p:column>

                                    <p:rowExpansion>
                                        <p:panelGrid columns="2" layout="grid"
                                                     styleClass="ui-panelgrid-blank"
                                                     columnClasses="ui-grid-col-2,ui-grid-col-10 text-limit-width">
                                            <p:outputLabel value="Tài sản thanh toán: "/>
                                            <h:outputText value="#{resultDto.assetName}"/>
                                        </p:panelGrid>

                                        <p:panelGrid id="detail-content" columns="4" layout="grid"
                                                     styleClass="ui-panelgrid-blank"
                                                     columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4">
                                            <p:outputLabel value="Mã giao dịch: "/>
                                            <h:outputText value="#{resultDto.code}"/>

                                            <p:outputLabel value="Người giao dịch: "/>
                                            <h:outputText value="#{resultDto.fullNameNguoiDangKy}"/>

                                            <p:outputLabel value="Thời gian thanh toán: "/>
                                            <h:outputText value="#{resultDto.createDate}">
                                                <f:convertDateTime pattern="HH:mm, dd/MM/yyyy"/>
                                            </h:outputText>

                                            <p:outputLabel value="Số tiền thanh toán: "/>
                                            <h:outputText value="#{resultDto.money}">
                                                <f:convertNumber type="currency"
                                                                 currencySymbol="VNĐ"
                                                                 maxFractionDigits="6"
                                                                 minFractionDigits="0"
                                                                 locale="vi_VN"/>
                                            </h:outputText>

                                            <p:outputLabel value="Hình thức thanh toán: "/>
                                            <h:outputText value="Thanh toán trực tiếp trên hệ thống"
                                                          rendered="#{resultDto.paymentFormality eq 1}"/>
                                            <h:outputText value="Thanh toán ngoài hệ thống"
                                                          rendered="#{resultDto.paymentFormality eq 2}"/>

                                            <p:outputLabel value="Trạng thái giao dịch: "/>
                                            <h:outputText value="Chưa nộp tiền đặt trước" rendered="#{resultDto.status eq 0}"/>
                                            <h:outputText value="Đã nhận được tiền đặt trước" rendered="#{resultDto.status eq 1}"/>
                                            <h:outputText value="Đã trả lại tiền đặt trước" rendered="#{resultDto.status eq 2}"/>

                                            <p:outputLabel value="Ghi chú giao dịch: " rendered="#{not empty resultDto.note}"/>
                                            <h:outputText value="#{resultDto.note}" rendered="#{not empty resultDto.note}"/>

                                            <p:outputLabel value="File đính kèm: " rendered="#{not empty resultDto.filePath}"/>

                                            <p:commandButton value="Tải về" style="width:80px;" ajax="false"
                                                             immediate="true" icon="fa fa-fw fa-download" rendered="#{not empty resultDto.filePath}">
                                                <p:fileDownload
                                                        value="#{uploadSingleFileController.getFileDownload(resultDto.filePath)}"/>
                                            </p:commandButton>

                                        </p:panelGrid>
                                    </p:rowExpansion>

                                    <p:column headerText="STT" width="30" style="text-align: center">
                                        <h:outputText value="#{rowIndex + 1}"/>
                                    </p:column>

                                    <p:column headerText="Mã giao dịch" sortBy="#{resultDto.code}" width="10%" style="text-align: center">
                                        <h:outputText value="#{resultDto.code}"/>
                                    </p:column>

                                    <p:column headerText="Người giao dịch" sortBy="#{resultDto.fullNameNguoiDangKy}" width="10%">
                                        <h:outputText value="#{resultDto.fullNameNguoiDangKy}"/>
                                    </p:column>

                                    <p:column headerText="Số tiền" sortBy="#{resultDto.money}" width="10%">
                                        <h:outputText value="#{resultDto.money}">
                                            <f:convertNumber type="currency"
                                                             currencySymbol="VNĐ"
                                                             maxFractionDigits="6"
                                                             minFractionDigits="0"
                                                             locale="vi_VN"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Thời gian giao dịch" style="text-align: center" width="10%"
                                              sortBy="#{resultDto.createDate}">
                                        <h:outputText value="#{resultDto.createDate}">
                                            <f:convertDateTime pattern="HH:mm, dd/MM/yyyy"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Hình thức giao dịch" sortBy="#{resultDto.paymentFormality}" width="12%">
                                        <h:outputText value="Thanh toán trực tiếp trên hệ thống"
                                                      rendered="#{resultDto.paymentFormality eq 1}"/>
                                        <h:outputText value="Thanh toán ngoài hệ thống"
                                                      rendered="#{resultDto.paymentFormality eq 2}"/>
                                    </p:column>

                                    <p:column headerText="Mã quy chế" style="text-align: center" width="10%" visible="false">
                                        <h:outputText value="#{resultDto.regulationCode}"/>
                                    </p:column>

                                    <p:column headerText="Mã quy chế" sortBy="#{resultDto.regulationCode}" exportable="false" width="10%" style="text-align: center;">
                                        <p:commandLink value="#{resultDto.regulationCode}" actionListener="#{paymentController.getFilePathRegulation(resultDto)}"
                                                       style="text-decoration: underline;" update="dialogRegulation"
                                                       oncomplete="PF('detailInfoDialogRegulation').show();"/>
                                    </p:column>

                                    <p:column headerText="Tài sản" sortBy="#{resultDto.assetName}" exportable="false">
                                        <h:outputText title="#{resultDto.assetName}" value="#{commonController.abbreviate(resultDto.assetName, DbConstant.LIMITCHARACTER)}"/>
                                    </p:column>

                                    <p:column headerText="Tài sản" visible="false">
                                        <h:outputText title="#{resultDto.assetName}" value="#{resultDto.assetName}"/>
                                    </p:column>

                                    <p:column headerText="Trạng thái" sortBy="#{resultDto.status}"  width="10%">
                                        <h:outputText value="Chưa nộp tiền đặt trước" rendered="#{resultDto.status eq 0}"/>
                                        <h:outputText value="Đã nhận được tiền đặt trước" rendered="#{resultDto.status eq 1}"/>
                                        <h:outputText value="Đã trả lại tiền đặt trước" rendered="#{resultDto.status eq 2}"/>
                                    </p:column>

                                    <p:column headerText="Ghi chú giao dịch: " visible="hidden">
                                        <h:outputText value="#{resultDto.note}"/>
                                    </p:column>

                                    <p:column headerText="Thời gian thanh toán: " visible="hidden">
                                        <h:outputText value="#{resultDto.createDate}">
                                            <f:convertDateTime pattern="dd/MM/yyyy"/>
                                        </h:outputText>
                                    </p:column>

                                    <p:column headerText="Cập nhật"
                                              exportable="false" width="40">
                                        <div class="my-data-table">
                                            <p:commandLink styleClass="edit"
                                                           oncomplete="PF('dialogInsertUpdate').show();"
                                                           update="dlForm growl" process="@this"
                                                           actionListener="#{paymentController.showUpdatePopup(resultDto)}">
                                                <p:confirm header="Xác nhận sửa"
                                                           message="Bạn chắc chắn muốn sửa giao dịch này không?"
                                                           icon="fa fa-question-circle"/>
                                                <i class="fa fa-edit"/>
                                            </p:commandLink>
                                        </div>
                                    </p:column>
                                </p:dataTable>
                                <p:panel header="Thống kê">
                                    <b>
                                        <p:outputLabel value="Tổng số tiền giao dịch trực tiếp trên hệ thống:  "/>
                                        <p:outputLabel value="#{paymentController.getTotalMonneyOnline()}">
                                            <f:convertNumber type="currency"
                                                             currencySymbol="VNĐ"
                                                             maxFractionDigits="6"
                                                             minFractionDigits="0"
                                                             locale="vi_VN"/>
                                        </p:outputLabel>
                                    </b>
                                    <br/>
                                    <b>
                                        <p:outputLabel value="Tổng số tiền giao dịch ngoài hệ thống: "/>
                                        <p:outputLabel value="#{paymentController.getTotalMonneyOffline()}">
                                            <f:convertNumber type="currency"
                                                             currencySymbol="VNĐ"
                                                             maxFractionDigits="6"
                                                             minFractionDigits="0"
                                                             locale="vi_VN"/>
                                        </p:outputLabel>
                                    </b>
                                </p:panel>
                            </p:panel>
                        </div>
                    </div>
                </div>
            </div>
        </h:form>
    </ui:define>
</ui:composition>
