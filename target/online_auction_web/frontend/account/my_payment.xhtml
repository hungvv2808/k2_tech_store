<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/frontend/template/template_detail.xhtml">

    <f:metadata>
        <f:event type="preRenderView" listener="#{paymentHistoryController.initData}"/>
    </f:metadata>

    <ui:define name="title">Lịch sử giao dịch</ui:define>
    <ui:param name="bodyStyleClass" value=""/>
    <ui:param name="headerStyleClass" value="is-sticky fixed-header"/>

    <ui:define name="breadcrumb">
        <li>Lịch sử giao dịch</li>
    </ui:define>

    <ui:define name="screenTitle">
        <h2>Lịch sử giao dịch</h2>
    </ui:define>

    <ui:define name="content">
        <style>
            th {
                text-align: center !important;
            }
        </style>
        <div class="row">
            <div class="filter">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <h:form role="form" novalidate="novalidate">
                        <div class="form-wrap">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-md-2 col-sm-2 col-xs-12 ">
                                        <label class="custom-label" style="width: auto;">Hiển thị:</label>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-xs-12 ">
                                        <h:selectOneMenu value="#{paymentHistoryController.paymentSearchDto.paymentFormality}" class="form-control br-5 text-dark">
                                            <f:ajax event="change" listener="#{paymentHistoryController.onSearch()}" render="dataMyPaymentHistory pagination"/>
                                            <f:selectItem itemValue="" itemLabel="Tất cả các giao dịch" />
                                            <f:selectItem itemValue="#{DbConstant.PAYMENT_FORMALITY_ONLINE}" itemLabel="Giao dịch trực tiếp trên hệ thống" />
                                            <f:selectItem itemValue="#{DbConstant.PAYMENT_FORMALITY_OFFLINE}" itemLabel="Giao dịch ngoài hệ thống" />
                                        </h:selectOneMenu>
                                    </div>
                                    <div class="col-md-2 col-sm-2 col-xs-12 ">
                                        <label class="custom-label" style="width: auto;">Trạng thái:</label>
                                    </div>
                                    <div class="col-md-4 col-sm-4 col-xs-12 ">
                                        <h:selectOneMenu value="#{paymentHistoryController.paymentSearchDto.status}" class="form-control br-5 text-dark">
                                            <f:ajax event="change" listener="#{paymentHistoryController.onSearch()}" render="dataMyPaymentHistory pagination"/>
                                            <f:selectItem itemValue="" itemLabel="Trạng thái giao dịch" />
                                            <f:selectItem itemValue="#{DbConstant.PAYMENT_STATUS_PAID}" itemLabel="Đã thanh toán" />
                                            <f:selectItem itemValue="#{DbConstant.PAYMENT_STATUS_REFUND}" itemLabel="Đã hoàn trả lại tiền trước" />
                                        </h:selectOneMenu>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </h:form>
                    <p class="note" style="margin-bottom: 10px;"><i class="fa fa-info-circle" aria-hidden="true"></i> Nhấn vào tên quy chế hoặc tên tài sản để xem thông tin chi tiết</p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 col-xs-12 col-sm-12">
                <h:panelGroup id="myPaymentHistoryPanel">
                    <table id="myPaymentHistory" class="display auction-table-content" style="width:100%">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã giao dịch</th>
                            <th>Thời gian giao dịch</th>
                            <th>Số tiền giao dịch</th>
                            <th>Tên tài sản</th>
                            <th>Loại giao dịch</th>
                            <th>Nội dung giao dịch</th>
                        </tr>
                        </thead>
                    </table>
                </h:panelGroup>
                <ui:include src="../template/paginate/pagination-ajax.xhtml">
                    <ui:param name="pagination" value="#{paymentHistoryController.pagination}"/>
                    <ui:param name="update" value="dataMyPaymentHistory"/>
                </ui:include>
            </div>
        </div>

        <h:form id="paymentDetailPopupShow" prependId="false" style="display: none !important;">
            <h:inputHidden id="paymentDetailPopupShowId" value="#{paymentHistoryController.paymentId}"/>
            <h:commandButton id="paymentDetailPopupShowSubmit" action="#{paymentHistoryController.getReceiptFilePathByPaymentId}">
                <f:ajax execute="@form" render="#{Constant.AREA_MODAL_RECEIPT_FILE_PATH} #{Constant.ERROR_FE_GROWL_ID} popupShowFile"/>
            </h:commandButton>
        </h:form>
    </ui:define>

    <ui:define name="jslibrary">
        <script>
            //<![CDATA[
            var formatter = new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
            });
            var data = "";
            var table = jQuery('#myPaymentHistory').DataTable({
                data: data,
                searching: false,
                ordering: false,
                info: false,
                autoWidth: false,
                scrollX: true,
                aaSorting: [],
                "sScrollX": "100%",
                "sScrollXInner": "100%",
                "bScrollCollapse": true,
                "bPaginate": false,
                dom: "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-4'l><'col-sm-8'p>>",
                language: {
                    'paginate': {
                        'next': '<i class="fa fa-angle-right" aria-hidden="true"></i>',
                        'previous': '<i class="fa fa-angle-left" aria-hidden="true"></i>'
                    },
                    "lengthMenu": "Hiển thị _MENU_ ",
                    "emptyTable": "Không tồn tại dữ liệu"
                },
                "columns": [{
                    "className": 'stt-column text-center ',
                    "data": null,
                    "render": function(data, type, full, meta) {
                        return data.serial_number;
                    }
                }, {
                    "data": null,
                    "render": function(data, type, full, meta) {
                        return '<a style="color: #F19B40" onclick="jQuery(\'#paymentDetailPopupShowId\').val(\''+data.payment_id+'\'); jQuery(\'#paymentDetailPopupShowSubmit\').click();">' + data.code + '</a>';
                    }
                }, {
                    "className": 'text-center',
                    "data": "create_date",
                }, {
                    "className": "text-right ",
                    "data": null,
                    "render": function(data, type, full, meta) {
                        return formatter.format(data.money).replace('₫', 'VNĐ');
                    },
                }, {
                    "className": "asset_name1",
                    "width": "100px",
                    "data": null,
                    "render": function(data, type, full, meta) {
                        return '<a style="color: #F19B40" href="' + urlContext + '/frontend/asset/asset_detail.xhtml?id=' + data.asset_id + '">' + data.asset_name + '</a> <a style="color: #F19B40" href="' + urlContext + '/frontend/regulation/regulation_detail.xhtml?id=' + data.regulation_id + '">(' + data.regulation_code + ')</a>';
                    }
                }, {
                    "data": null,
                    "render": function(data, type, full, meta) {
                        if (data.payment_formality === '#{DbConstant.PAYMENT_FORMALITY_ONLINE}') {
                            return 'Giao dịch trực tiếp trên hệ thống'
                        }
                        if (data.payment_formality === '#{DbConstant.PAYMENT_FORMALITY_OFFLINE}') {
                            return 'Giao dịch ngoài hệ thống'
                        }
                        return null;
                    }
                }, {
                    "className": 'text-center ',
                    "data": null,
                    "render": function(data, type, full, meta) {
                        if (data.status === '#{DbConstant.PAYMENT_STATUS_PAID}') {
                            return 'Đã thanh toán'
                        }
                        if (data.status === '#{DbConstant.PAYMENT_STATUS_REFUND}') {
                            return 'Đã hoàn trả lại tiền trước'
                        }
                        return null;
                    }
                },/* {
                    "data": "note",
                }*/],
            });
            table.columns.adjust().draw();
            //]]>
        </script>

        <style>
            .dataTables_wrapper.no-footer .dataTables_scrollBody {
                border-bottom: 1px solid #ECECEC;
            }
            table.dataTable table.dataTable {
                border-bottom: none !important;
            }
            .asset_name1 {
                min-width: 150px;
                max-width: 200px;
            }
            .asset_name1 a:first-child {
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }
        </style>

        <ui:include src="modal/modal_payment_detail.xhtml"/>

        <h:panelGroup id="dataMyPaymentHistory">
            <h:outputScript>
                var data = #{paymentHistoryController.pagination.dataString};
                table.clear();
                table.rows.add(data).draw();
            </h:outputScript>
        </h:panelGroup>
    </ui:define>
</ui:composition>
