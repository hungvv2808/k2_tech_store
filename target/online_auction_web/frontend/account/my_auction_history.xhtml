<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/frontend/template/template_detail.xhtml">

    <f:metadata>
        <f:event type="preRenderView" listener="#{propertySaleHistoryController.initData}"/>
    </f:metadata>

    <ui:define name="title">Lịch sử mua bán tài sản</ui:define>
    <ui:param name="bodyStyleClass" value=""/>
    <ui:param name="headerStyleClass" value="is-sticky fixed-header"/>

    <ui:define name="breadcrumb">
        <li>Lịch sử mua bán tài sản</li>
    </ui:define>

    <ui:define name="screenTitle">
        <h2>Lịch sử mua bán tài sản</h2>
    </ui:define>

    <ui:define name="content">
        <div class="row">
            <div class="filter">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <h:form role="form" novalidate="novalidate" prependId="false">
                        <div class="form-wrap">
                            <div class="form-group">
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <label class="custom-label">Hiển thị:</label>
                                        </div>
                                        <div class="col-md-4 col-sm-4 col-xs-12">
                                            <h:selectOneMenu
                                                    id="display-type"
                                                    value="#{propertySaleHistoryController.searchDto.checkStatusSearch}"
                                                    onchange="changeType(this.value);"
                                                    class="form-control br-5 text-dark">
                                                <f:ajax event="change"
                                                        listener="#{propertySaleHistoryController.onSearch()}"
                                                        render="dataMyAuctionHistory pagination"/>
                                                <f:selectItem itemValue="#{propertySaleHistoryController.SEARCH_ALL}"
                                                              itemLabel="Tất cả các hoạt động"/>
                                                <f:selectItem itemValue="#{propertySaleHistoryController.SEARCH_BY_SALE}"
                                                              itemLabel="Hoạt động đăng ký bán tài sản"/>
                                                <f:selectItem itemValue="#{propertySaleHistoryController.SEARCH_BY_BUY}"
                                                              itemLabel="Hoạt động đăng ký tham gia đấu giá"/>
                                            </h:selectOneMenu>
                                        </div>
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <label class="custom-label">Mã quy chế:</label>
                                        </div>
                                        <div class="col-md-4 col-sm-4 col-xs-12">
                                            <h:inputText value="#{propertySaleHistoryController.searchDto.regulationCode}"
                                                         placeholder="Nhập mã quy chế"
                                                         styleClass="form-control br-5 text-dark">
                                            </h:inputText>
                                        </div>
                                    </div>

                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <label>Thời gian bắt đầu tổ chức đấu giá: </label>
                                        </div>
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <div class="input-group date">
                                                <h:inputText styleClass="form-control datetimepicker1 fromDate" id="fromdate"
                                                             placeholder="Từ ngày" autocomplete="false" onfocus="focusRemoveReadOnly(this);"
                                                             value="#{propertySaleHistoryController.searchDto.fromDate}">
                                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                </h:inputText>
                                                <span class="input-group-addon" onclick="document.getElementById('fromdate').focus()">
                                                    <i class="custom-icon calendar"/>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <div class="input-group date">
                                                <h:inputText styleClass="form-control datetimepicker1 toDate" id="todate"
                                                             placeholder="Đến ngày" autocomplete="false" onfocus="focusRemoveReadOnly(this);"
                                                             value="#{propertySaleHistoryController.searchDto.toDate}">
                                                    <f:convertDateTime pattern="dd/MM/yyyy"/>
                                                </h:inputText>
                                                <span class="input-group-addon" onclick="document.getElementById('todate').focus()">
                                                    <i class="custom-icon calendar"/>
                                                </span>
                                            </div>
                                        </div>

                                        <div class="col-md-2 col-sm-2 col-xs-12 ">
                                            <label class="custom-label">Tên tài sản:</label>
                                        </div>
                                        <div class="col-md-4 col-sm-4 col-xs-12 ">
                                            <h:inputText value="#{propertySaleHistoryController.searchDto.assetName}"
                                                         placeholder="Nhập tên tài sản"
                                                         styleClass="form-control br-5 text-dark">
                                            </h:inputText>
                                        </div>
                                    </div>

                                    <div id="area-active" class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="display: none">
                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <label class="custom-label">Trạng thái:</label>
                                        </div>
                                        <div class="col-md-4 col-sm-4 col-xs-12">
                                            <h:selectOneMenu
                                                    value="#{propertySaleHistoryController.searchDto.activeStatus}"
                                                    class="form-control br-5 text-dark">
                                                <f:ajax event="change"
                                                        listener="#{propertySaleHistoryController.onSearch()}"
                                                        render="dataMyAuctionHistory pagination"/>
                                                <f:selectItem itemValue="-1"
                                                              itemLabel="Tất cả"/>
                                                <f:selectItem itemValue="#{Constant.HIS_REFUSE_TO_PARTICIPATE_IN_AUCTION}"
                                                              itemLabel="Từ chối tham gia đấu giá"/>
                                                <f:selectItem itemValue="#{Constant.HIS_INVALID_REGISTRATION}"
                                                              itemLabel="Đăng ký không hợp lệ"/>
                                                <f:selectItem itemValue="#{Constant.HIS_JOIN_THE_AUCTION}"
                                                              itemLabel="Tham gia đấu giá"/>
                                                <f:selectItem itemValue="#{Constant.HIS_DO_NOT_PARTICIPATE_IN_THE_AUCTION}"
                                                              itemLabel="Không tham gia đấu giá"/>
                                                <f:selectItem itemValue="#{Constant.HIS_DISQUALIFIED_BY_THE_PROFESSORS}"
                                                              itemLabel="Bị ĐGV truất quyền"/>
                                                <f:selectItem itemValue="#{Constant.HIS_REFUSING_TO_WIN_THE_AUCTION}"
                                                              itemLabel="Từ chối trúng đấu giá"/>
                                                <f:selectItem itemValue="#{Constant.HIS_WINNING_THE_AUCTION}"
                                                              itemLabel="Trúng đấu giá"/>
                                                <f:selectItem itemValue="#{Constant.HIS_WITHDRAW_THE_PRICE_PAID}"
                                                              itemLabel="Rút lại giá đã trả"/>
                                            </h:selectOneMenu>
                                        </div>

                                        <div class="col-md-2 col-sm-2 col-xs-12">
                                            <label class="custom-label">Tuỳ chọn: </label>
                                        </div>
                                        <div class="col-md-4 col-sm-4 col-xs-12">
                                            <div class="row">
                                                <div class="col-lg-1">
                                                    <h:selectBooleanCheckbox id="checkBoxWin" value="#{propertySaleHistoryController.searchDto.statusWin}"/>
                                                </div>
                                                <div class="col-lg-11">
                                                    <h:outputLabel value="Bạn trúng đấu giá, chờ ký số biên bản đấu giá" for="checkBoxWin" style="padding-top: 15px"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-30">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 submit-area text-center">
                                <h:commandLink value="Tìm kiếm" styleClass="btn btn-custom main-color"
                                               style="margin-right: 5px"
                                               actionListener="#{propertySaleHistoryController.onSearch}">
                                    <f:ajax execute="@form" render="@this dataMyAuctionHistory pagination #{Constant.ERROR_FE_GROWL_ID}"/>
                                </h:commandLink>

                                <h:commandLink value="Làm mới" styleClass="btn btn-success"
                                               style="margin-left: 5px; text-transform: uppercase;"
                                               actionListener="#{propertySaleHistoryController.resetAll}">
                                    <f:ajax execute="@form" render="@form dataMyAuctionHistory pagination scriptResetListener #{Constant.ERROR_FE_GROWL_ID}"/>
                                </h:commandLink>
                            </div>
                        </div>
                    </h:form>
                    <p class="note" style="margin-bottom: 10px;">
                        <i class="fa fa-info-circle" aria-hidden="true"/> Nhấn vào tên quy chế hoặc tên tài sản để xem thông tin chi tiết
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 col-xs-12 col-sm-12">
                <h:panelGroup id="myAuctionHistoryPanel">
                    <table id="myAuctionHistory" class="display auction-table-content" style="width:100%">
                        <thead>
                        <tr>
                            <th></th>
                            <th>STT</th>
                            <th>Thời gian đăng ký</th>
                            <th>Hoạt động</th>
                            <th>Tên tài sản</th>
                            <th>Ghi chú</th>
                        </tr>
                        </thead>
                    </table>
                </h:panelGroup>
                <ui:include src="../template/paginate/pagination-ajax.xhtml">
                    <ui:param name="pagination" value="#{propertySaleHistoryController.pagination}"/>
                    <ui:param name="update" value="dataMyAuctionHistory"/>
                </ui:include>
            </div>
        </div>

        <h:form id="signatureForm" prependId="false" style="display: none !important;">
            <h:inputHidden id="regulationId" value="#{propertySaleHistoryController.regulationId}"/>
            <h:inputHidden id="assetId" value="#{propertySaleHistoryController.assetId}"/>
            <h:commandButton id="signatureFileBillSubmit" action="#{propertySaleHistoryController.signatureFileBill()}">
                <f:ajax execute="@form" render="@form sign-report-form myAuctionHistory #{Constant.ERROR_FE_GROWL_ID}"/>
            </h:commandButton>
        </h:form>

        <script>
            jQuery(".datetimepicker1").mask('99/99/9999');
        </script>
    </ui:define>

    <ui:define name="jslibrary">
        <script>
            //<![CDATA[
            function changeType(e) {
                if(e==='#{propertySaleHistoryController.SEARCH_BY_BUY}') {
                    jQuery('#area-active').show();
                } else {
                    jQuery('#area-active').hide();
                }
            }

            function focusRemoveReadOnly(e) {
                var date = jQuery("#fromDate").val();
                if (e.getAttribute('readonly') !== null) {
                    e.removeAttribute('readonly');
                    e.blur();
                    setTimeout(function() {
                        e.focus();
                    }, 10)
                }
            }

            jQuery(document).ready(function () {
                changeType(jQuery('#display-type').val());
                jQuery(document).on('focus', ':input', function() {
                    jQuery(this).attr('autocomplete', 'off');
                });
            });

            /* Formatting function for row details - modify as you need */
            function formatWin(d) {
                // `d` is the original data object for the row
                return '<table id="example' + d.id + '" class="display subtable-content" style="width:100%"></table>';
            }

            var data = "";
            var table = jQuery('#myAuctionHistory').DataTable({
                data: data,
                searching: false,
                ordering: false,
                info: false,
                autoWidth: false,
                scrollX: true,
                aaSorting: [],
                "sScrollX": "100%",
                "sScrollXInner": "100%",
                "bScrollCollapse": true,
                "bPaginate": false,
                dom: "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-4'l><'col-sm-8'p>>",
                language: {
                    'paginate': {
                        'next': '<i class="fa fa-angle-right" aria-hidden="true"></i>',
                        'previous': '<i class="fa fa-angle-left" aria-hidden="true"></i>'
                    },
                    "lengthMenu": "Hiển thị _MENU_ ",
                    "emptyTable": "Không tồn tại dữ liệu"
                },
                "columns": [{
                    "className": 'details-control',
                    "orderable": false,
                    "data": null,
                    "defaultContent": '',
                }, {
                    "className": 'stt-column text-center ',
                    "orderable": false,
                    "data": null,
                    "render": function (data, type, full, meta) {
                        return data.serial_number;
                    }
                }, {
                    "data": "time_auction",
                }, {
                    "data": null,
                    "render": function (data, type, full, meta) {
                        if (data.type) {
                            return '<i class="custom-icon success"></i>&nbsp;Đăng ký tham gia đấu giá';
                        } else {
                            return '<i class="custom-icon busy"></i>&nbsp;Đăng ký bán tài sản';
                        }
                    },
                }, {
                    "className": 'asset_name ',
                    "width": "20%",
                    "defaultContent": '',
                    "data": null,
                    "render": function (data, type, full, meta) {
                        if (data.type) {
                            return '<a style="color: #F19B40" href="' + urlContext + '/frontend/asset/asset_detail.xhtml?id=' + data.asset_id + '" title="' + data.asset_name + '">' + data.asset_name + '</a>';
                        } else {
                            return '<a style="color: #F19B40" class="asset_name_detail">' + data.asset_name + '</a>';
                        }
                    },
                }, {
                    "data": "note_user"
                }],
            });
            table.columns.adjust().draw();
            // Add event listener for opening and closing details
            jQuery('#myAuctionHistory tbody').on('click', 'td.details-control,.asset_name_detail', function () {
                var tr = jQuery(this).closest('tr');
                var row = table.row(tr);
                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    // Open this row
                    var columns = [
                        {
                            "title": "Mã quy chế",
                            "orderable": false,
                            "defaultContent": '',
                            "className": 'hide-icon text-center',
                            "data": null,
                            "render": function (data, type, full, meta) {
                                return data.regulation_id == null ? '' : '<a href="' + urlContext + '/frontend/regulation/regulation_detail.xhtml?id=' + data.regulation_id + '">' + data.code + '</a>';
                            },
                        }, {
                            "title": "Thời gian bắt đầu cuộc đấu giá",
                            "className": 'text-center',
                            "data": null,
                            "render": function (data, type, full, meta) {
                                return data.regulation_id == null ? '' : data.start_time;
                            },
                        },
                    ];

                    if (row.data().type) {
                        columns.push({
                            "title": "Trạng thái",
                            "className": 'text-center',
                            "data": "status_user"
                        }, {
                            "title": "Trạng thái tiền đặt trước",
                            "className": 'text-center',
                            "data": "status_payment"
                        },);

                        if (row.data().asset_status_ending) {
                            if (row.data().id === row.data().winner_id) {
                                columns.push({
                                    "title": "Biên bản đấu giá",
                                    "className": 'text-center',
                                    "data": null,
                                    "render": function (data, type, full, meta) {
                                        var signature = '<a href="#" data-toggle="tooltip" title="Ký biên bản" onclick="jQuery(\'#regulationId\').val(\'' + data.regulation_id + '\'); jQuery(\'#assetId\').val(\'' + data.asset_id + '\'); jQuery(\'#signatureFileBillSubmit\').click();">' +
                                            '<i class="fa fa-pencil" aria-hidden="true"></i><br/>Ký biên bản' +
                                            '</a>';
                                        return '<div class="action-button">' + signature + '</div>';
                                    },
                                }, {
                                    "title": "Trạng thái ký số",
                                    "className": 'text-center',
                                    "data": null,
                                    "render": function (data, type, full, meta) {
                                        if (data.signature === '#{DbConstant.REGULATION_REPORT_USER_SIGNED}') {
                                            return 'Đã gửi biên bản ký số';
                                        }
                                        return 'Chưa gửi biên bản đấu giá';
                                    },
                                })
                            }
                        }
                    } else {
                        columns.push({
                            "title": "Hình thức đấu giá",
                            "className": 'text-center',
                            "data": "auction_formality_name"
                        }, {
                            "title": "Phương thức đấu giá",
                            "className": 'text-center',
                            "data": "auction_method_name"
                        },)
                    }


                    row.child(formatWin(row.data())).show();
                    var subtable = jQuery('#example' + row.data().id).DataTable({
                        data: row.data().regulation,
                        searching: false,
                        ordering: false,
                        info: false,
                        autoWidth: false,
                        lengthChange: false,
                        paging: false,
                        scrollX: true,
                        "sScrollX": "98%",
                        "sScrollXInner": "98%",
                        language: {
                            'paginate': {
                                'next': '<i class="fa fa-angle-right" aria-hidden="true"></i>',
                                'previous': '<i class="fa fa-angle-left" aria-hidden="true"></i>'
                            },
                            "lengthMenu": "Hiển thị _MENU_ ",
                            "emptyTable": "Không tồn tại dữ liệu"
                        },
                        "columns": columns
                    });

                    tr.addClass('shown');
                    tr.next('tr').addClass('shownchild')
                }
            });

            //]]>
        </script>


        <style>
            .dataTables_wrapper.no-footer .dataTables_scrollBody {
                border-bottom: 1px solid #ECECEC;
                overflow-x: hidden !important;
            }

            table.dataTable table.dataTable {
                border-bottom: none !important;
            }

            .asset_name a:first-child {
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }

            .subtable-content {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            th {
                text-align: center !important;
            }

            .action-button a {
                width: 100% !important;
            }
        </style>

        <h:panelGroup id="dataMyAuctionHistory">
            <h:outputScript>
                var data = #{propertySaleHistoryController.pagination.dataString};
                table.clear();
                table.rows.add(data).draw();
                jQuery('.detail').each(function(i, e) {
                jQuery(e).parent().removeClass('details-control');
                });
            </h:outputScript>
        </h:panelGroup>

        <ui:include src="../regulation/modal/modal_sign_report.xhtml"/>
    </ui:define>
</ui:composition>
